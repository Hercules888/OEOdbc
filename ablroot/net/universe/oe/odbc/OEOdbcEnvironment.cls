/*------------------------------------------------------------------------
This file is part of the OEOdbc library, an OpenEdge ABL wrapper
around the ODBC libraries.


Copyright (C) 2013-2015 hercules888@gmail.com

This library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with this library; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

http://www.gnu.org/licenses/lgpl-2.1.txt
----------------------------------------------------------------------*/

using net.universe.oe.odbc.*.

{net/universe/oe/odbc/oe-odbc-defs.i}

routine-level on error undo, throw.
class net.universe.oe.odbc.OEOdbcEnvironment:
  def public property iEnvHandle as {&DEF_SQLHENV} no-undo init 0
  public get.
  private set.
  
  constructor public OEOdbcEnvironment():
    def var iRetVal as {&DEF_SQLSMALLINT} no-undo.

    iRetVal = OEOdbcApi:Instance:SQLAllocHandle({&SQL_HANDLE_ENV}, {&SQL_NULL_HANDLE}, output iEnvHandle).
    OEOdbcUtil:Instance:throwExceptionIfRequiredWithExtras({&SQL_HANDLE_ENV}, iEnvHandle, iRetVal, "Unable to allocate Environment").

    setOdbcVersion(3).
  end constructor.
  
  destructor public OEOdbcEnvironment():
    def var iRetVal as int no-undo.
    
    if iEnvHandle <> 0 and iEnvHandle <> ? then do:
      ASSIGN iRetVal = OEOdbcApi:Instance:SQLFreeHandle({&SQL_HANDLE_ENV}, iEnvHandle).
      /*
      OEOdbcUtil:Instance:throwExceptionIfRequiredWithExtras({&SQL_HANDLE_ENV}, iEnvHandle, iRetVal, "Unable to free Environment").
      */
    end.
  end destructor.
  
  method PUBLIC OEOdbcConnection getConnection(input cServerName     as char,
                                               input cUserName       as char,
                                               input cAuthentication as char):
     
    def var iDbcHandle as {&DEF_SQLHDBC} no-undo init 0.
    def var oCon as OEOdbcConnection no-undo.
    
    assign oCon = new OEOdbcConnection(this-object, cServerName, cUserName, cAuthentication). 
    return oCon.
  end method.

  /* - windows : The components of the connection string can be found in the register when an ODBC datasource is created :
       HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\ODBC\ODBC.INI
     - linux :
       /etc/odbcinst.ini
           
     Connection string formats :
     - PostgreSQL windows   : "DRIVER=酗篝珧逵烟疹殂镤妣挥弪鲥蝾犴褰俭弪鲥蚓恍矧艚拣矧艟荒狒徕狍褰间忸犴寰徽赡郊躞弪钺礤净嗅篌黠蜾郊疳篌黠蜾劲酗篝珧逵烟扉铛⒛疑峙医酗篝珧逵烟挥弪鲥蝾犴褰俭弪鲥蚓恍矧艚拣矧艟荒狒徕狍褰间忸犴寰徽赡郊躞弪钺礤净嗅篌黠蜾郊疳篌黠蜾劲恿攘瘟鏖钿秣⒛疑峙医饶孪穆贸猖幻攘疫劣哒云附被渝蝣弪物溴郊箦蝣弪竞拣矧艟徽赡郊躞弪犴寰恍啄郊疳篌黠蜾劲恿攘瘟扉铛⒛疑峙医攘瘟幻攘疫劣哒云附被渝蝣弪物溴郊箦蝣弪竞拣矧艟徽赡郊躞弪犴寰恍啄郊疳篌黠蜾劲礤翳镤姓绿擅吓箱忏蔑铑邈糸镱珏裘镱铄泗轱瞑轭瘐忝镱铄泗轱钣趄轭狍汨狎┖溴鲠槟忏柔钿戾狍δ牌哂烟饶旅铒躅滹轭轸爱溴鲠锩镱狍吓箱忏蔑铑邈糸镱铒躅滹狍箝珙锩镱铄吓箱忏蔑铑邈糸镱翳轶镡赍泗忝镱铄泗轱钣趄轭绌蝈趱蝾锩镱孱礤翳镤澡轶铄邃麸忮骈邃盹蝈篝蝓泗躜犰禊礤翳镤瘐忪殂鲲殇箦粝溻阒弪箝镱ㄩ铕豸橄溻阒弪箝镱狍轭舂溴鲠橐弭轴狍轭铒躅滹溴鲠砹趑蛑犰狍礤眇趄铒躅滹箦舡痫轭翦颦鲠祯濞砹趑蛑犰橄溻阒弪箝镱橐弭轴吓箱忏琉楹深篝犷沐河烟渝襞铞留趄ㄩ蓬鋈犷潇瀣τ烟吡栽疫夏旅咧乓由衔砹趑蛑犰癌吓箱忏蒸殪荷铙翎钽搴翳蝻髋沐痿轱钌嬉羼蹰蝈渥轸枧趄狍τ烟呷廖奶胚盼铸榕铞柔钿戾橐弭轴飕⒄钺忪麸箦箱忏皱蝮轱狒趄殁豸镱蓬鲩蝻铐孱簪┊孱礤翳镤孱沆狍螽